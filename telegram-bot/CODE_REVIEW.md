# üìã –ö–û–î –†–ï–í–¨–Æ: TELEGRAM SUBSCRIPTION BOT

**–î–∞—Ç–∞:** 2026-01-11
**–ü—Ä–æ–µ–∫—Ç:** D:\Bot\telegram-bot
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** TypeScript, Telegraf, Prisma, SQLite, Express
**–í–µ—Ä—Å–∏—è:** 1.0.0

---

## üìñ –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [üö® –ü–†–û–ë–õ–ï–ú–´ –°–¢–†–£–ö–¢–£–†–´ –ü–†–û–ï–ö–¢–ê (–ù–û–í–û–ï)](#–ø—Ä–æ–±–ª–µ–º—ã-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã-–ø—Ä–æ–µ–∫—Ç–∞)
3. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
4. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–±–∞–≥–∏)
5. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
6. [–ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞](#–ø—Ä–æ–±–ª–µ–º—ã-–∫–∞—á–µ—Å—Ç–≤–∞-–∫–æ–¥–∞)
7. [–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)
8. [–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π](#–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π-–ø–ª–∞–Ω-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)
9. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

---

## üéØ –û–ë–ó–û–† –ü–†–û–ï–ö–¢–ê

### –û–ø–∏—Å–∞–Ω–∏–µ
Telegram-–±–æ—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –¥–≤—É—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (Fondy –∏ WayForPay).

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ (1, 3, 6 –º–µ—Å—è—Ü–µ–≤)
- –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Fondy (EUR) –∏–ª–∏ WayForPay (UAH)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ SQLite —á–µ—Ä–µ–∑ Prisma ORM

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
telegram-bot/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ bot.ts                            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ db/prisma.ts                      # Prisma client
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ subscriptionService.ts        # –õ–æ–≥–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ fondy.service.ts          # Fondy –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ wayforpay.service.ts      # WayForPay –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ payment.types.ts          # –¢–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ storage/subscriptionStore.ts      # Database layer
‚îÇ   ‚îú‚îÄ‚îÄ scheduler/notificationScheduler.ts # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
‚îÇ   ‚îî‚îÄ‚îÄ webhooks/
‚îÇ       ‚îú‚îÄ‚îÄ fondy.webhook.ts              # Fondy callbacks
‚îÇ       ‚îî‚îÄ‚îÄ wayforpay.webhook.ts          # WayForPay callbacks
‚îú‚îÄ‚îÄ prisma/schema.prisma                  # DB schema
‚îî‚îÄ‚îÄ package.json
```

---

## üö® –ü–†–û–ë–õ–ï–ú–´ –°–¢–†–£–ö–¢–£–†–´ –ü–†–û–ï–ö–¢–ê

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2026-01-11 23:33

–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤:

### ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–¥–∞–ª–µ–Ω—ã –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã

–°–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:

1. **`telegram-bot/dist/`** ‚úÖ –£–î–ê–õ–ï–ù–û
   - –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JavaScript –∫–æ–¥
   - –î–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ, –∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ git
   - –†–∞–∑–º–µ—Ä: ~50 —Ñ–∞–π–ª–æ–≤ (.js, .d.ts, .map)

2. **`telegram-bot/prisma/dev.db`** ‚úÖ –£–î–ê–õ–ï–ù–û
   - SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   - –°–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
   - –î–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ `prisma migrate dev`

3. **`D:\Bot/package.json`** ‚úÖ –£–î–ê–õ–ï–ù–û
   - –î—É–±–ª–∏—Ä—É—é—â–∏–π —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
   - –°–æ–¥–µ—Ä–∂–∞–ª —Ç–æ–ª—å–∫–æ `@prisma/client`
   - –û—Å–Ω–æ–≤–Ω–æ–π package.json –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `telegram-bot/`

4. **`D:\Bot/node_modules/`** ‚úÖ –£–î–ê–õ–ï–ù–û
   - –î—É–±–ª–∏—Ä—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
   - –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ `telegram-bot/node_modules/`

### ‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

#### 1. –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª payment.types.ts

**–§–∞–π–ª:** `src/services/payment/payment.types.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```bash
$ ls -lh src/services/payment/payment.types.ts
-rw-r--r-- 1 user user 0 Jan  1 15:05 payment.types.ts  # ‚ùå 0 –±–∞–π—Ç!
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –§–∞–π–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∏–ø–æ–≤
- –í –∫–æ–¥–µ —Ä–µ–≤—å—é —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∏–ø—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- –°–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `any` –∏–ª–∏ `Record<string, any>` –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–≥–∏—Ö —Ç–∏–ø–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any` —Ç–∏–ø–æ–≤":

```typescript
// src/services/payment/payment.types.ts

export interface FondyPaymentRequest {
  merchant_id: string;
  order_id: string;
  order_desc: string;
  amount: number;        // –≤ —Ü–µ–Ω—Ç–∞—Ö
  currency: string;
  server_callback_url: string;
  signature?: string;
}

export interface FondyPaymentResponse {
  orderId: string;
  url: string;
}

export interface WayForPayPaymentRequest {
  merchantAccount: string;
  merchantDomainName: string;
  orderReference: string;
  orderDate: number;
  amount: number;        // –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency: string;
  productName: string[];
  productPrice: number[];
  productCount: number[];
  serviceUrl: string;
  merchantSignature?: string;
}

export interface WayForPayPaymentResponse {
  orderId: string;
  payload: WayForPayPaymentRequest;
}

export type PaymentProvider = 'fondy' | 'wayforpay';
export type Currency = 'EUR' | 'UAH';
```

---

#### 2. –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –≤ production –∫–æ–¥–µ

**–§–∞–π–ª:** `src/test/testPrisma.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `src/`
- –ë—É–¥–µ—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –≤ `dist/` –∏ –ø–æ–ø–∞–¥–µ—Ç –≤ production bundle
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Å–±–æ—Ä–∫–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

**–†–µ—à–µ–Ω–∏–µ:**

**–í–∞—Ä–∏–∞–Ω—Ç –ê:** –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ç–µ—Å—Ç–æ–≤:
```bash
mkdir tests
mv src/test/testPrisma.ts tests/
rm -rf src/test/
```

**–í–∞—Ä–∏–∞–Ω—Ç –ë:** –£–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
```bash
rm -rf src/test/
```

**–û–±–Ω–æ–≤–∏—Ç—å tsconfig.json:**
```json
{
  "compilerOptions": {
    // ...
  },
  "include": ["src/**/*"],
  "exclude": [
    "node_modules",
    "dist",
    "tests",      // ‚Üê –∏—Å–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç—ã
    "**/*.test.ts",
    "**/*.spec.ts"
  ]
}
```

---

#### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ - –∫–æ—Ä–µ–Ω—å vs telegram-bot

**–ü—Ä–æ–±–ª–µ–º–∞:**
–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
D:\Bot/
‚îú‚îÄ‚îÄ .git/
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ telegram-bot/          # –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–¥–µ—Å—å
    ‚îú‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ prisma/
    ‚îú‚îÄ‚îÄ package.json
    ‚îî‚îÄ‚îÄ ...
```

**–í–æ–ø—Ä–æ—Å—ã:**
- –ó–∞—á–µ–º –æ–±–µ—Ä—Ç–∫–∞ `telegram-bot/` –µ—Å–ª–∏ —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏?
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ `D:\Bot/`?

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

**–í–∞—Ä–∏–∞–Ω—Ç –ê (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):** –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—Å—ë –≤ –∫–æ—Ä–µ–Ω—å
```bash
cd D:\Bot
mv telegram-bot/* .
mv telegram-bot/.* .  # —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã
rmdir telegram-bot
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
D:\Bot/
‚îú‚îÄ‚îÄ .git/
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ prisma/
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ ...
```

**–í–∞—Ä–∏–∞–Ω—Ç –ë:** –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è mono-repo:
```
D:\Bot/
‚îú‚îÄ‚îÄ telegram-bot/          # —Ç–µ–∫—É—â–∏–π –±–æ—Ç
‚îú‚îÄ‚îÄ telegram-admin-bot/    # –±—É–¥—É—â–∏–π admin –±–æ—Ç
‚îú‚îÄ‚îÄ shared/                # –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
‚îî‚îÄ‚îÄ packages/
```

---

### üìã –û–ë–ù–û–í–õ–ï–ù–ù–´–ô .gitignore

–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `.gitignore` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:

```gitignore
# Dependencies
node_modules/
package-lock.json
yarn.lock
pnpm-lock.yaml

# Build output
dist/
build/
*.tsbuildinfo

# Environment variables (–ö–†–ò–¢–ò–ß–ù–û!)
.env
.env.local
.env.*.local
*.env

# Database files
*.db
*.db-journal
*.sqlite
*.sqlite3
prisma/dev.db
prisma/test.db

# Logs
logs/
*.log
npm-debug.log*

# Testing
coverage/
.nyc_output/

# IDE
.vscode/
.idea/
*.swp
.DS_Store

# OS files
Thumbs.db

# Temporary
temp/
tmp/
.cache/
```

---

### ‚úÖ CHECKLIST –û–ß–ò–°–¢–ö–ò –ü–†–û–ï–ö–¢–ê

–ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∫–æ–º–º–∏—Ç–æ–º –≤ git:

- [x] –£–¥–∞–ª–∏—Ç—å `dist/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- [x] –£–¥–∞–ª–∏—Ç—å `*.db` —Ñ–∞–π–ª—ã
- [x] –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ `node_modules/`
- [x] –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ `package.json` –≤ –∫–æ—Ä–Ω–µ
- [ ] –ó–∞–ø–æ–ª–Ω–∏—Ç—å `payment.types.ts` —Ç–∏–ø–∞–º–∏
- [ ] –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å `src/test/testPrisma.ts`
- [ ] –†–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (–∫–æ—Ä–µ–Ω—å vs telegram-bot/)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `.env` –≤ `.gitignore`
- [ ] –û—Ç–æ–∑–≤–∞—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å `BOT_TOKEN`

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### 1. –£—Ç–µ—á–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞

**–§–∞–π–ª:** `.env:1`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```env
BOT_TOKEN=8576020716:AAGfvZsQZQbKneVRN33Cfkv3kYM44WW78Mg
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- –õ—é–±–æ–π –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –±–æ—Ç–æ–º
- –í–æ–∑–º–æ–∂–Ω–∞ –∫—Ä–∞–∂–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–†–µ—à–µ–Ω–∏–µ:**
1. **–ù–ï–ú–ï–î–õ–ï–ù–ù–û** –æ—Ç–∑–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ @BotFather:
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/mybots` ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ ‚Üí API Token ‚Üí Revoke current token
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
3. –î–æ–±–∞–≤—å—Ç–µ `.env` –≤ `.gitignore`:
   ```gitignore
   .env
   .env.local
   .env.*.local
   ```
4. –ï—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –≤ git:
   ```bash
   git rm --cached .env
   git commit -m "Remove sensitive .env file"
   ```

---

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–§–∞–π–ª:** `src/index.ts:14`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const bot = new Telegraf(process.env.BOT_TOKEN as string);
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è `BOT_TOKEN`
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–¥–µ—Ç —Å –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–π –æ—à–∏–±–∫–æ–π –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∑–∞–¥–∞–Ω–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `FONDY_SECRET`, `WFP_SECRET`, `BASE_URL`

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/config.ts
import dotenv from 'dotenv';

dotenv.config();

interface Config {
  BOT_TOKEN: string;
  DATABASE_URL: string;
  FONDY_MERCHANT_ID: string;
  FONDY_SECRET: string;
  WFP_ACCOUNT: string;
  WFP_SECRET: string;
  BASE_URL: string;
}

function validateEnv(): Config {
  const requiredEnvVars = [
    'BOT_TOKEN',
    'DATABASE_URL',
    'FONDY_MERCHANT_ID',
    'FONDY_SECRET',
    'WFP_ACCOUNT',
    'WFP_SECRET',
    'BASE_URL'
  ];

  const missing = requiredEnvVars.filter(key => !process.env[key]);

  if (missing.length > 0) {
    throw new Error(
      `Missing required environment variables: ${missing.join(', ')}\n` +
      `Please check your .env file.`
    );
  }

  return {
    BOT_TOKEN: process.env.BOT_TOKEN!,
    DATABASE_URL: process.env.DATABASE_URL!,
    FONDY_MERCHANT_ID: process.env.FONDY_MERCHANT_ID!,
    FONDY_SECRET: process.env.FONDY_SECRET!,
    WFP_ACCOUNT: process.env.WFP_ACCOUNT!,
    WFP_SECRET: process.env.WFP_SECRET!,
    BASE_URL: process.env.BASE_URL!,
  };
}

export const config = validateEnv();
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
// src/index.ts
import { config } from './config.js';

const bot = new Telegraf(config.BOT_TOKEN);
```

---

### 3. –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any` —Ç–∏–ø–æ–≤

**–§–∞–π–ª—ã:**
- `src/services/payment/fondy.service.ts:26`
- `src/services/payment/wayforpay.service.ts:29`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const payload: Record<string, any> = { ... }  // fondy
const payload: any = { ... }                  // wayforpay
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç type-safety –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –æ—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –æ—à–∏–±–æ–∫ –≤ production

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/services/payment/payment.types.ts

export interface FondyPaymentRequest {
  merchant_id: string;
  order_id: string;
  order_desc: string;
  amount: number;
  currency: string;
  server_callback_url: string;
  signature?: string;
}

export interface WayForPayPaymentRequest {
  merchantAccount: string;
  merchantDomainName: string;
  orderReference: string;
  orderDate: number;
  amount: number;
  currency: string;
  productName: string[];
  productPrice: number[];
  productCount: number[];
  serviceUrl: string;
  merchantSignature?: string;
}
```

```typescript
// src/services/payment/fondy.service.ts
export async function createFondyPayment(
  userId: number,
  amount: number
) {
  const payload: FondyPaymentRequest = {
    merchant_id: FONDY_MERCHANT_ID!,
    order_id: `fondy_${userId}_${Date.now()}`,
    order_desc: 'Telegram subscription',
    amount: amount * 100, // –≤ —Ü–µ–Ω—Ç–∞—Ö!
    currency: 'EUR',
    server_callback_url: `${BASE_URL}/webhook/fondy`
  };

  payload.signature = createSignature(payload);

  // ...
}
```

---

### 4. Hard-coded –¥–æ–º–µ–Ω

**–§–∞–π–ª:** `src/services/payment/wayforpay.service.ts:31`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
merchantDomainName: 'yourdomain.com',
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –î–æ–º–µ–Ω –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –≤ –∫–æ–¥–µ
- –ë—É–¥–µ—Ç –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ production
- WayForPay –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –∏–∑-–∑–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–æ–º–µ–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// .env
WFP_MERCHANT_DOMAIN=yourdomain.com

// wayforpay.service.ts
merchantDomainName: process.env.WFP_MERCHANT_DOMAIN!,
```

---

## üêõ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ë–ê–ì–ò

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `src/services/subscriptionService.ts:10-11`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const endDate = new Date(startDate);
endDate.setMonth(endDate.getMonth() + 1); // ‚ùå –í–°–ï–ì–î–ê 1 –º–µ—Å—è—Ü!
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤ –∑–∞ 55‚Ç¨
- –ù–æ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ 1 –º–µ—Å—è—Ü –¥–æ—Å—Ç—É–ø–∞
- **–≠—Ç–æ –ø—Ä—è–º–æ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—â–µ—Ä–± –∫–ª–∏–µ–Ω—Ç–∞–º!**

**–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
1. –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ "6 –º–µ—Å—è—Ü–µ–≤ - 55‚Ç¨"
2. –û–ø–ª–∞—Ç–∏—Ç—å
3. –í –ë–î —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 1 –º–µ—Å—è—Ü –≤–º–µ—Å—Ç–æ 6

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/services/subscriptionService.ts
import { SubscriptionType } from '../bot.js';

function getPlanDurationMonths(plan: string | null): number {
  switch (plan) {
    case SubscriptionType.HOME_1_MONTH:
      return 1;
    case SubscriptionType.HOME_3_MONTHS:
      return 3;
    case SubscriptionType.HOME_6_MONTHS:
      return 6;
    default:
      return 1; // fallback
  }
}

export async function createSubscription(data: {
  telegramId: number;
  username: string;
  plan?: string | null;
}) {
  const startDate = new Date();
  const endDate = new Date(startDate);

  const durationMonths = getPlanDurationMonths(data.plan);
  endDate.setMonth(endDate.getMonth() + durationMonths);

  const subscription: Subscription = {
    telegramId: data.telegramId,
    username: data.username,
    startDate,
    endDate,
    notified: false,
    plan: data.plan ?? null,
  };

  await db.addSubscription(subscription);

  console.log(
    `–°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞: ${data.username}, ` +
    `–ø–ª–∞–Ω: ${data.plan} (${durationMonths} –º–µ—Å.), ` +
    `—Å ${startDate.toISOString()} –ø–æ ${endDate.toISOString()}`
  );
}
```

---

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –ø—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏

**–§–∞–π–ª:** `src/scheduler/notificationScheduler.ts:30`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
sub.notified = true;
await db.addSubscription(sub); // ‚ùå —Å–æ–∑–¥–∞—ë—Ç –î–£–ë–õ–ò–ö–ê–¢!
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ú–µ—Ç–æ–¥ `addSubscription` —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –ë–î
- –ù–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É
- –ö–∞–∂–¥–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç –ø–æ–¥–ø–∏—Å–∫–∏
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –∑–∞–º—É—Å–æ—Ä–µ–Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏

**–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
1. –î–æ–∂–¥–∞—Ç—å—Å—è, –ø–æ–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥–æ–π–¥–µ—Ç –∫ –∫–æ–Ω—Ü—É (–∑–∞ 5 –¥–Ω–µ–π)
2. Scheduler –æ—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
3. –í –ë–î –ø–æ—è–≤–∏—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç –ø–æ–¥–ø–∏—Å–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/storage/subscriptionStore.ts
export const db = {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã ...

  async updateSubscriptionNotified(telegramId: number, notified: boolean) {
    await prisma.subscription.updateMany({
      where: {
        telegramId,
        endDate: { gt: new Date() } // —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
      },
      data: { notified }
    });
  },
};
```

```typescript
// src/scheduler/notificationScheduler.ts
for (const sub of subscriptions) {
  if (sub.notified) continue;

  const notifyAt = new Date(sub.endDate.getTime() - FIVE_DAYS_MS);
  if (now >= notifyAt) {
    try {
      await bot.telegram.sendMessage(
        sub.telegramId,
        `‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n\n` +
        `–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç–µ–∫–∞–µ—Ç ${sub.endDate.toLocaleDateString()}.\n` +
        `–ü—Ä–æ–¥–ª–∏—Ç–µ –µ—ë, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ üí™`
      );

      // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
      await db.updateSubscriptionNotified(sub.telegramId, true);

      console.log(`Notification sent to user ${sub.telegramId}`);
    } catch (err) {
      console.error(`Failed to send notification to ${sub.telegramId}:`, err);
    }
  }
}
```

---

### 3. –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è WayForPay

**–§–∞–π–ª:** `src/bot.ts:106`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
Markup.button.url(
  '–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ',
  `${process.env.BASE_URL}/pay/wayforpay/${payment.orderId}`
)
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ú–∞—Ä—à—Ä—É—Ç `/pay/wayforpay/:orderId` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç 404
- –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ WayForPay –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞
- –¢–µ—Ä—è–µ—Ç—Å—è —á–∞—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ –ê (–ü—Ä–æ—Å—Ç–æ–π - —Ñ–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã):**
```typescript
// src/index.ts
app.get('/pay/wayforpay/:orderId', async (req, res) => {
  const { orderId } = req.params;

  // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ –ë–î –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ
  const userId = orderId.split('_')[1];
  const amount = 600; // TODO: –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ë–î

  const payment = createWayForPayPayment(Number(userId), amount);

  // HTML —Ñ–æ—Ä–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>–û–ø–ª–∞—Ç–∞</title>
    </head>
    <body>
      <form id="paymentForm" action="https://secure.wayforpay.com/pay" method="POST">
        ${Object.entries(payment.payload).map(([key, value]) =>
          `<input type="hidden" name="${key}" value="${Array.isArray(value) ? value.join(';') : value}">`
        ).join('\n')}
      </form>
      <script>
        document.getElementById('paymentForm').submit();
      </script>
    </body>
    </html>
  `;

  res.send(html);
});
```

**–†–µ—à–µ–Ω–∏–µ –ë (–õ—É—á—à–µ - API –≥–µ–Ω–µ—Ä–∞—Ü–∏—è URL):**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WayForPay Invoice API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–∏ (–∫–∞–∫ –≤ Fondy).

---

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è Fondy

**–§–∞–π–ª:** `src/services/payment/fondy.service.ts:30`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
amount, // ‚ùå –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ü–µ–Ω—Ç–∞—Ö!
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- Fondy –æ–∂–∏–¥–∞–µ—Ç —Å—É–º–º—É –≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö –≤–∞–ª—é—Ç—ã (—Ü–µ–Ω—Ç—ã –¥–ª—è EUR)
- –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `12` –≤–º–µ—Å—Ç–æ `1200`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç 0.12‚Ç¨ –≤–º–µ—Å—Ç–æ 12‚Ç¨
- **–ü—Ä—è–º–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ—Ç–µ—Ä—è –¥–ª—è –±–∏–∑–Ω–µ—Å–∞!**

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Fondy:**
> amount: —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö (–∫–æ–ø–µ–π–∫–∏, —Ü–µ–Ω—Ç—ã –∏ —Ç.–¥.)

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
export async function createFondyPayment(
  userId: number,
  amount: number
) {
  const payload: FondyPaymentRequest = {
    merchant_id: FONDY_MERCHANT_ID!,
    order_id: `fondy_${userId}_${Date.now()}`,
    order_desc: 'Telegram subscription',
    amount: amount * 100, // ‚úÖ 12‚Ç¨ ‚Üí 1200 —Ü–µ–Ω—Ç–æ–≤
    currency: 'EUR',
    server_callback_url: `${BASE_URL}/webhook/fondy`
  };

  payload.signature = createSignature(payload);

  // ...
}
```

---

### 5. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å body-parser

**–§–∞–π–ª:** `src/index.ts:8, 22`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
import bodyParser from 'body-parser'; // ‚ùå –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
// ...
app.use(bodyParser.json());
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `body-parser` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `package.json`
- –ü—Ä–∏ —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ `npm install` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
- –í Express 5.x body-parser –≤—Å—Ç—Ä–æ–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/index.ts
import express from 'express';
// ‚ùå import bodyParser from 'body-parser'; // —É–¥–∞–ª–∏—Ç—å

const app = express();
app.use(express.json()); // ‚úÖ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π
```

---

## ‚öôÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –î–û –æ–ø–ª–∞—Ç—ã

**–§–∞–π–ª:** `src/bot.ts:44`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// –®–∞–≥ 1: –°–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∏—Å–∫—É
await createSubscription({ ... });

// –®–∞–≥ 2: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã
await ctx.reply('–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ:', ...);
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü† –í–´–°–û–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∞—Ä–∏—Ñ–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–µ –æ–ø–ª–∞—Ç–∏—Ç—å
- –í –ë–î –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è —Ç—ã—Å—è—á–∏ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –ù–µ—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É `Payment` –∏ `Subscription`
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –∫–∞–∫–æ–π –ø–ª–∞—Ç–µ–∂ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –∫–∞–∫—É—é –ø–æ–¥–ø–∏—Å–∫—É

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. –ó–∞–º—É—Å–æ—Ä–∏–≤–∞–Ω–∏–µ –ë–î
2. –ù–µ—Ç–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
3. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é (–≤—ã–±–æ—Ä ‚Üí –æ–ø–ª–∞—Ç–∞)
4. –°–ª–æ–∂–Ω–æ –æ—Ç–º–µ–Ω—è—Ç—å/–≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–µ–Ω—å–≥–∏

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π flow:**
```
–í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ ‚Üí –û–ø–ª–∞—Ç–∞ ‚Üí Webhook ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
```

**–†–µ—à–µ–Ω–∏–µ:**

**–®–∞–≥ 1:** –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å `PendingSubscription` –≤ —Å—Ö–µ–º—É:
```prisma
// prisma/schema.prisma

model PendingSubscription {
  id         Int      @id @default(autoincrement())
  telegramId Int
  username   String
  plan       String
  orderId    String   @unique
  createdAt  DateTime @default(now())
}

model Subscription {
  id         Int      @id @default(autoincrement())
  telegramId Int
  username   String
  startDate  DateTime
  endDate    DateTime
  notified   Boolean  @default(false)
  plan       String?
  paymentId  Int?     @unique  // ‚úÖ —Å–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–æ–º
  payment    Payment? @relation(fields: [paymentId], references: [id])

  @@index([telegramId])
  @@index([endDate])
}

model Payment {
  id           Int           @id @default(autoincrement())
  orderId      String        @unique
  userId       String
  provider     String
  amount       Int
  currency     String
  createdAt    DateTime      @default(now())
  subscription Subscription? // —Å–≤—è–∑—å —Å –ø–æ–¥–ø–∏—Å–∫–æ–π
}
```

**–®–∞–≥ 2:** –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ bot.ts:
```typescript
// src/bot.ts
bot.action([...], async (ctx) => {
  const user = ctx.from;
  if (!user) return;

  const selectedPlan = ctx.match?.[0] as SubscriptionType;

  // ‚úÖ –ù–ï —Å–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∏—Å–∫—É, —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ
  await db.createPendingSubscription({
    telegramId: user.id,
    username: user.username ?? `${user.first_name} ${user.last_name ?? ''}`.trim(),
    plan: selectedPlan
  });

  await ctx.answerCbQuery();
  await ctx.reply(
    '–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ:',
    Markup.inlineKeyboard([...])
  );
});
```

**–®–∞–≥ 3:** –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ webhook –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã:
```typescript
// src/webhooks/fondy.webhook.ts
export async function fondyWebhookHandler(req: Request, res: Response) {
  // ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ ...

  if (data.order_status !== 'approved') {
    return res.send('Ignored');
  }

  const orderId = data.order_id;
  const userId = orderId.split('_')[1];

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞
  const alreadyProcessed = await db.isPaymentProcessed(orderId);
  if (alreadyProcessed) return res.send('Already processed');

  // ‚úÖ –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞–º–µ—Ä–µ–Ω–∏–∏
  const pending = await db.getPendingSubscriptionByUserId(userId);
  if (!pending) {
    console.error(`No pending subscription for user ${userId}`);
    return res.status(400).send('No pending subscription');
  }

  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç—ë–∂
  const payment = await db.markPaymentProcessed({
    orderId,
    userId,
    provider: 'fondy',
    amount: data.amount,
    currency: data.currency,
  });

  // ‚úÖ –¢–û–õ–¨–ö–û –°–ï–ô–ß–ê–° —Å–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∏—Å–∫—É
  await createSubscription({
    telegramId: pending.telegramId,
    username: pending.username,
    plan: pending.plan,
    paymentId: payment.id
  });

  // ‚úÖ –í—ã–¥–∞—ë–º –¥–æ—Å—Ç—É–ø
  await grantTelegramAccess(userId);

  // ‚úÖ –£–¥–∞–ª—è–µ–º pending –∑–∞–ø–∏—Å—å
  await db.deletePendingSubscription(pending.id);

  res.send('OK');
}
```

---

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–§–∞–π–ª—ã:** –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// bot.ts:85
const payment = await createFondyPayment(userId, amount);
// ‚ùå –ß—Ç–æ –µ—Å–ª–∏ API Fondy –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?

// index.ts:18
bot.launch();
// ‚ùå –ß—Ç–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω?

// webhooks/*.ts
await grantTelegramAccess(userId);
// ‚ùå –ß—Ç–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞?
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü† –í–´–°–û–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤–æ –≤—Å—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ø–∞–¥–∞–µ—Ç
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

**–†–µ—à–µ–Ω–∏–µ:**

**1. –ì–ª–æ–±–∞–ª—å–Ω—ã–π error handler –¥–ª—è –±–æ—Ç–∞:**
```typescript
// src/index.ts
bot.catch((err, ctx) => {
  console.error('Bot error:', err);
  ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.');
});
```

**2. Try-catch –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:**
```typescript
// src/bot.ts
bot.on('callback_query', async (ctx) => {
  if (!ctx.callbackQuery || !('data' in ctx.callbackQuery)) return;
  const data = ctx.callbackQuery?.data;
  if (!data) return;

  const userId = ctx.from!.id;

  if (data.startsWith('pay_fondy:')) {
    try {
      const plan = data.split(':')[1] as SubscriptionType;
      const amount = getAmountByPlan(plan, 'EUR');
      const payment = await createFondyPayment(userId, amount);

      await ctx.answerCbQuery();
      await ctx.reply(
        'üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (Fondy):',
        Markup.inlineKeyboard([Markup.button.url('–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', payment.url)])
      );
    } catch (error) {
      console.error('Fondy payment creation failed:', error);
      await ctx.answerCbQuery();
      await ctx.reply(
        '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.'
      );
    }
  }
});
```

**3. Retry logic –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
```typescript
// src/utils/retry.ts
export async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  maxRetries = 3,
  initialDelay = 1000
): Promise<T> {
  let lastError: Error;

  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error as Error;
      console.warn(`Attempt ${i + 1} failed:`, error);

      if (i < maxRetries - 1) {
        const delay = initialDelay * Math.pow(2, i);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  throw lastError!;
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
await retryWithBackoff(
  () => bot.telegram.sendMessage(userId, message),
  3,
  1000
);
```

**4. Error logging:**
```typescript
// src/utils/logger.ts
import winston from 'winston';

export const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});
```

---

### 3. Stub —Ñ—É–Ω–∫—Ü–∏—è grantTelegramAccess

**–§–∞–π–ª:** `src/bot.ts:125`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
export async function grantTelegramAccess(userId: string) {
  console.log(`Access granted to ${userId}`); // ‚ùå –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç!
}
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
- Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ù–æ –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è
- –§—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ—Ç, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É—Å–ª—É–≥—É!**

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∑–∞–∫—Ä—ã—Ç—ã–π –∫–∞–Ω–∞–ª**
```typescript
export async function grantTelegramAccess(userId: string, bot: Telegraf) {
  const PRIVATE_CHANNEL_ID = process.env.PRIVATE_CHANNEL_ID!; // '@your_channel' –∏–ª–∏ '-100...'

  try {
    // –°–æ–∑–¥–∞—ë–º invite link –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const inviteLink = await bot.telegram.createChatInviteLink(
      PRIVATE_CHANNEL_ID,
      {
        member_limit: 1, // —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        expire_date: Math.floor(Date.now() / 1000) + 86400 // –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
      }
    );

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—Å—ã–ª–∫—É
    await bot.telegram.sendMessage(
      Number(userId),
      `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ.\n\n` +
      `–í–∞—à –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.\n\n` +
      `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∫–∞–Ω–∞–ª—É: ${inviteLink.invite_link}`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: 'üèãÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º', url: inviteLink.invite_link }
          ]]
        }
      }
    );

    logger.info(`Access granted to user ${userId}, invite link sent`);
  } catch (error) {
    logger.error(`Failed to grant access to user ${userId}:`, error);
    throw error;
  }
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞**
```typescript
export async function grantTelegramAccess(userId: string, bot: Telegraf) {
  try {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
    await db.activateUserAccess(Number(userId));

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await bot.telegram.sendMessage(
      Number(userId),
      `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ.\n\n` +
      `–í–∞—à –¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.\n\n` +
      `–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /trainings –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.`,
      {
        reply_markup: {
          keyboard: [
            [{ text: 'üèãÔ∏è –ú–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏' }],
            [{ text: 'üìä –ü—Ä–æ–≥—Ä–µ—Å—Å' }, { text: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏' }]
          ],
          resize_keyboard: true
        }
      }
    );

    logger.info(`Access granted to user ${userId}`);
  } catch (error) {
    logger.error(`Failed to grant access to user ${userId}:`, error);

    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –ø—Ä–æ–±–ª–µ–º–µ
    await notifyAdminAboutError(userId, error);

    throw error;
  }
}
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Google Drive, Dropbox)**
```typescript
export async function grantTelegramAccess(userId: string, bot: Telegraf) {
  const TRAINING_FILES_FOLDER_ID = process.env.GOOGLE_DRIVE_FOLDER_ID!;

  try {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ø–∞–ø–∫—É —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏
    const accessLink = await generateGoogleDriveAccessLink(
      TRAINING_FILES_FOLDER_ID,
      userId
    );

    await bot.telegram.sendMessage(
      Number(userId),
      `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ.\n\n` +
      `–í–∞—à–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ —Å—Å—ã–ª–∫–µ:\n${accessLink}\n\n` +
      `–î–æ—Å—Ç—É–ø –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –ø–æ–¥–ø–∏—Å–∫–∏.`
    );

    logger.info(`Access granted to user ${userId}`);
  } catch (error) {
    logger.error(`Failed to grant access to user ${userId}:`, error);
    throw error;
  }
}
```

**–í–∞–∂–Ω–æ:** –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–∏ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö:
```typescript
// src/webhooks/fondy.webhook.ts
await grantTelegramAccess(userId, bot); // –ø–µ—Ä–µ–¥–∞—Ç—å bot instance

// –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å singleton
// src/bot.ts
export let botInstance: Telegraf;

export function setupBot(bot: Telegraf) {
  botInstance = bot;
  // ... rest of setup
}

// src/webhooks/fondy.webhook.ts
import { botInstance } from '../bot.js';
await grantTelegramAccess(userId, botInstance);
```

---

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–≤—è–∑–∏ Payment ‚Üî Subscription

**–§–∞–π–ª:** `prisma/schema.prisma`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```prisma
model Subscription {
  id         Int      @id @default(autoincrement())
  telegramId Int
  // ‚ùå –Ω–µ—Ç —Å–≤—è–∑–∏ —Å Payment
}

model Payment {
  id      Int    @id @default(autoincrement())
  orderId String @unique
  // ‚ùå –Ω–µ—Ç —Å–≤—è–∑–∏ —Å Subscription
}
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü† –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å, –∫–∞–∫–æ–π –ø–ª–∞—Ç–µ–∂ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –∫–∞–∫—É—é –ø–æ–¥–ø–∏—Å–∫—É
- –°–ª–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å refund/–≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
- –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–ø–æ—Ä–æ–≤ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
```prisma
model Subscription {
  id         Int       @id @default(autoincrement())
  telegramId Int
  username   String
  startDate  DateTime
  endDate    DateTime
  notified   Boolean   @default(false)
  plan       String?
  paymentId  Int?      @unique
  payment    Payment?  @relation(fields: [paymentId], references: [id])

  @@index([telegramId])
  @@index([endDate])
}

model Payment {
  id           Int           @id @default(autoincrement())
  orderId      String        @unique
  userId       String
  provider     String
  amount       Int
  currency     String
  createdAt    DateTime      @default(now())
  subscription Subscription?
}
```

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
```bash
npx prisma migrate dev --name add_payment_subscription_relation
```

---

## üìù –ü–†–û–ë–õ–ï–ú–´ –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ console.log –≤–º–µ—Å—Ç–æ logger

**–§–∞–π–ª—ã:** –í—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
console.log('Bot started');
console.log(`Access granted to ${userId}`);
console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', err);
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –ù–ò–ó–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- `console.log` –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è production
- –ù–µ—Ç —É—Ä–æ–≤–Ω–µ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (info, warn, error, debug)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏
- –ù–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
- –°–ª–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ production

**–†–µ—à–µ–Ω–∏–µ:**
```bash
npm install winston
```

```typescript
// src/utils/logger.ts
import winston from 'winston';

const logFormat = winston.format.combine(
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.errors({ stack: true }),
  winston.format.json()
);

export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: logFormat,
  defaultMeta: { service: 'telegram-bot' },
  transports: [
    // –û—à–∏–±–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error',
      maxsize: 5242880, // 5MB
      maxFiles: 5
    }),

    // –í—Å–µ –ª–æ–≥–∏
    new winston.transports.File({
      filename: 'logs/combined.log',
      maxsize: 5242880,
      maxFiles: 5
    })
  ]
});

// –í development —Ç–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.combine(
      winston.format.colorize(),
      winston.format.simple()
    )
  }));
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
// src/index.ts
import { logger } from './utils/logger.js';

logger.info('Bot started', { port: 3000 });

// src/bot.ts
logger.info('Access granted', { userId });

// src/scheduler/notificationScheduler.ts
logger.error('Failed to send notification', {
  userId: sub.telegramId,
  error: err.message,
  stack: err.stack
});
```

---

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–§–∞–π–ª:** `src/bot.ts:74-111`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// Fondy
if (data.startsWith('pay_fondy:')) {
  const plan = data.split(':')[1] as SubscriptionType;
  const amount = getAmountByPlan(plan, 'EUR');
  const payment = await createFondyPayment(userId, amount);
  // ...
}

// WayForPay - –ø–æ—á—Ç–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π –∫–æ–¥
if (data.startsWith('pay_wayforpay:')) {
  const plan = data.split(':')[1] as SubscriptionType;
  const amount = getAmountByPlan(plan, 'UAH');
  const payment = await createWayForPayPayment(userId, amount);
  // ...
}
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –ù–ò–ó–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ DRY (Don't Repeat Yourself)
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö
- –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—à–∏–±–æ–∫

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/bot.ts

type PaymentProvider = 'fondy' | 'wayforpay';

interface PaymentConfig {
  currency: 'EUR' | 'UAH';
  emoji: string;
  name: string;
  createPayment: (userId: number, amount: number) => Promise<{ orderId: string; url: string }>;
}

const PAYMENT_PROVIDERS: Record<PaymentProvider, PaymentConfig> = {
  fondy: {
    currency: 'EUR',
    emoji: 'üí≥',
    name: 'Fondy',
    createPayment: createFondyPayment
  },
  wayforpay: {
    currency: 'UAH',
    emoji: 'üá∫üá¶',
    name: 'WayForPay',
    createPayment: async (userId, amount) => {
      const payment = createWayForPayPayment(userId, amount);
      return {
        orderId: payment.orderId,
        url: `${process.env.BASE_URL}/pay/wayforpay/${payment.orderId}`
      };
    }
  }
};

async function handlePayment(
  ctx: any,
  provider: PaymentProvider,
  plan: SubscriptionType
) {
  const userId = ctx.from!.id;
  const config = PAYMENT_PROVIDERS[provider];

  try {
    const amount = getAmountByPlan(plan, config.currency);
    const payment = await config.createPayment(userId, amount);

    await ctx.answerCbQuery();
    await ctx.reply(
      `${config.emoji} –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (${config.name}):`,
      Markup.inlineKeyboard([
        Markup.button.url('–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', payment.url)
      ])
    );
  } catch (error) {
    logger.error(`Payment creation failed`, { provider, error });
    await ctx.answerCbQuery();
    await ctx.reply('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

bot.on('callback_query', async (ctx) => {
  if (!ctx.callbackQuery || !('data' in ctx.callbackQuery)) return;
  const data = ctx.callbackQuery?.data;
  if (!data) return;

  // Fondy
  if (data.startsWith('pay_fondy:')) {
    const plan = data.split(':')[1] as SubscriptionType;
    await handlePayment(ctx, 'fondy', plan);
  }

  // WayForPay
  if (data.startsWith('pay_wayforpay:')) {
    const plan = data.split(':')[1] as SubscriptionType;
    await handlePayment(ctx, 'wayforpay', plan);
  }
});
```

---

### 3. Magic numbers

**–§–∞–π–ª:** `src/scheduler/notificationScheduler.ts:36`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const FIVE_DAYS_MS = 5 * 24 * 60 * 60 * 1000; // ‚úÖ —Ö–æ—Ä–æ—à–æ

setInterval(async () => {
  // ...
}, 60 * 60 * 1000); // ‚ùå magic number
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç `60 * 60 * 1000`
- –°–ª–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª
- –ö–æ–¥ –º–µ–Ω–µ–µ —á–∏—Ç–∞–µ–º

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
const FIVE_DAYS_MS = 5 * 24 * 60 * 60 * 1000;
const CHECK_INTERVAL_MS = 60 * 60 * 1000; // 1 —á–∞—Å
const CHECK_INTERVAL_HOURS = 1;

export function startNotificationScheduler(bot: Telegraf) {
  logger.info(`Starting notification scheduler (interval: ${CHECK_INTERVAL_HOURS}h)`);

  setInterval(async () => {
    // ...
  }, CHECK_INTERVAL_MS);
}
```

---

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `src/bot.ts:83, 97`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const plan = data.split(':')[1] as SubscriptionType;
// ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ plan - –≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ enum
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- Type assertion `as` –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ runtime
- –í–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Å—É–º–º—ã

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
function isValidSubscriptionType(value: string): value is SubscriptionType {
  return Object.values(SubscriptionType).includes(value as SubscriptionType);
}

bot.on('callback_query', async (ctx) => {
  if (!ctx.callbackQuery || !('data' in ctx.callbackQuery)) return;
  const data = ctx.callbackQuery?.data;
  if (!data) return;

  const userId = ctx.from!.id;

  if (data.startsWith('pay_fondy:')) {
    const planValue = data.split(':')[1];

    if (!isValidSubscriptionType(planValue)) {
      logger.warn(`Invalid plan value: ${planValue}`, { userId });
      await ctx.answerCbQuery('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ');
      return;
    }

    const plan = planValue as SubscriptionType;
    // ... –¥–∞–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º plan
  }
});
```

---

### 5. Type-safety –Ω–∞—Ä—É—à–µ–Ω–∏—è

**–§–∞–π–ª:** `src/bot.ts:76-79`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const data = ctx.callbackQuery?.data; // –º–æ–∂–µ—Ç –±—ã—Ç—å undefined
if (!data) return;

const userId = ctx.from!.id; // –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ! –æ–ø–∞—Å–Ω–æ
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ non-null assertion `!` –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ runtime –æ—à–∏–±–∫–∞–º
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
bot.on('callback_query', async (ctx) => {
  if (!ctx.callbackQuery || !('data' in ctx.callbackQuery)) return;

  const data = ctx.callbackQuery.data;
  if (!data) return;

  const user = ctx.from;
  if (!user) {
    logger.warn('Callback query without user');
    return;
  }

  const userId = user.id;

  // ... –¥–∞–ª—å—à–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏
});
```

---

### 6. Hardcoded —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π

**–§–∞–π–ª:** `src/bot.ts` –∏ –¥—Ä—É–≥–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
await ctx.reply(
  `–ü—Ä–∏–≤–µ—Ç, ${firstName}! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª(–∞) –º–µ–Ω—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–≤–æ–µ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞!`
);
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –¢–µ–∫—Å—Ç—ã —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ –∫–æ–¥—É
- –°–ª–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (i18n)
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/messages/ru.ts
export const messages = {
  welcome: (firstName: string) =>
    `–ü—Ä–∏–≤–µ—Ç, ${firstName}! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª(–∞) –º–µ–Ω—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–≤–æ–µ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞!\n\n` +
    `–í—ã–±–µ—Ä–∏ –Ω–∏–∂–µ –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä–∞—è —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.`,

  payment_select: '–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ:',

  payment_link_fondy: 'üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (Fondy):',
  payment_link_wayforpay: 'üá∫üá¶ –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (WayForPay):',

  payment_error: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',

  notification_expiring: (endDate: string) =>
    `‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n\n` +
    `–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å—Ç–µ–∫–∞–µ—Ç ${endDate}.\n` +
    `–ü—Ä–æ–¥–ª–∏—Ç–µ –µ—ë, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ üí™`,
};

// src/bot.ts
import { messages } from './messages/ru.js';

bot.start(async (ctx) => {
  const firstName = ctx.from?.first_name ?? '–¥—Ä—É–≥';
  await ctx.reply(messages.welcome(firstName), ...);
});
```

---

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏

**–§–∞–π–ª:** `src/services/payment/fondy.service.ts:10-19`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
function createSignature(data: Record<string, any>) {
  const ordered = Object.keys(data)
    .sort()
    .map(k => data[k])
    .join('|');

  return crypto
    .createHash('sha1')
    .update(`${FONDY_SECRET}|${ordered}`)
    .digest('hex');
}
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –°–ª–æ–∂–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –ø–æ—Ä—è–¥–æ–∫ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏
- –°–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
/**
 * –°–æ–∑–¥–∞–µ—Ç SHA1 –ø–æ–¥–ø–∏—Å—å –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ Fondy API
 *
 * –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Fondy:
 * 1. –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
 * 2. –í–∑—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
 * 3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —á–µ—Ä–µ–∑ |
 * 4. –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ secret key
 * 5. –í—ã—á–∏—Å–ª–∏—Ç—å SHA1 —Ö–µ—à
 *
 * –ü—Ä–∏–º–µ—Ä: { amount: 100, merchant_id: 123 }
 * ‚Üí "secret|100|123" ‚Üí SHA1
 *
 * @param data - –û–±—ä–µ–∫—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–ª–∞—Ç–µ–∂–∞ (–±–µ–∑ signature)
 * @returns Hex-—Å—Ç—Ä–æ–∫–∞ SHA1 –ø–æ–¥–ø–∏—Å–∏
 */
function createSignature(data: Record<string, any>): string {
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –∏ –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
  const orderedValues = Object.keys(data)
    .sort()
    .map(key => data[key])
    .join('|');

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É: secret|value1|value2|...
  const signatureString = `${FONDY_SECRET}|${orderedValues}`;

  // –í—ã—á–∏—Å–ª—è–µ–º SHA1 —Ö–µ—à
  return crypto
    .createHash('sha1')
    .update(signatureString)
    .digest('hex');
}
```

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç graceful shutdown

**–§–∞–π–ª:** `src/index.ts:18`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
bot.launch();
// ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞/—Å–µ—Ä–≤–µ—Ä–∞ –±–æ—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Ä–µ–∑–∫–æ
- –ú–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å—Å—è –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
- Webhook'–∏ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/index.ts
import { logger } from './utils/logger.js';

const bot = new Telegraf(config.BOT_TOKEN);
setupBot(bot);
startNotificationScheduler(bot);

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch()
  .then(() => logger.info('Bot started successfully'))
  .catch(err => {
    logger.error('Failed to start bot:', err);
    process.exit(1);
  });

// Express server
const app = express();
app.use(express.json());

app.post('/webhook/fondy', fondyWebhookHandler);
app.post('/webhook/wayforpay', wayForPayWebhookHandler);

const server = app.listen(3000, () => {
  logger.info('Server started on port 3000');
});

// Graceful shutdown
const shutdown = async (signal: string) => {
  logger.info(`${signal} received, starting graceful shutdown...`);

  try {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–µ–º –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    server.close(() => {
      logger.info('HTTP server closed');
    });

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
    await bot.stop(signal);
    logger.info('Bot stopped');

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
    await prisma.$disconnect();
    logger.info('Database connection closed');

    logger.info('Graceful shutdown completed');
    process.exit(0);
  } catch (error) {
    logger.error('Error during shutdown:', error);
    process.exit(1);
  }
};

process.once('SIGINT', () => shutdown('SIGINT'));
process.once('SIGTERM', () => shutdown('SIGTERM'));

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
process.on('unhandledRejection', (reason, promise) => {
  logger.error('Unhandled Rejection at:', { promise, reason });
});

process.on('uncaughtException', (error) => {
  logger.error('Uncaught Exception:', error);
  shutdown('UNCAUGHT_EXCEPTION');
});
```

---

### 2. Hardcoded —Ü–µ–Ω—ã

**–§–∞–π–ª:** `src/bot.ts:116-121`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const prices: Record<SubscriptionType, { EUR: number; UAH: number }> = {
  [SubscriptionType.HOME_1_MONTH]: { EUR: 12, UAH: 600 },
  [SubscriptionType.HOME_3_MONTHS]: { EUR: 30, UAH: 1500 },
  [SubscriptionType.HOME_6_MONTHS]: { EUR: 55, UAH: 2800 }
};
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –¶–µ–Ω—ã –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ –∫–æ–¥–µ
- –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫–æ–¥ –∏ –¥–µ–ª–∞—Ç—å redeploy
- –ù–µ—Ç –≥–∏–±–∫–æ—Å—Ç–∏ –¥–ª—è A/B —Ç–µ—Å—Ç–æ–≤ –∏–ª–∏ –∞–∫—Ü–∏–π

**–†–µ—à–µ–Ω–∏–µ –ê (Environment variables):**
```typescript
// .env
PRICE_1M_EUR=12
PRICE_1M_UAH=600
PRICE_3M_EUR=30
PRICE_3M_UAH=1500
PRICE_6M_EUR=55
PRICE_6M_UAH=2800

// src/config/pricing.ts
export const pricing = {
  [SubscriptionType.HOME_1_MONTH]: {
    EUR: Number(process.env.PRICE_1M_EUR),
    UAH: Number(process.env.PRICE_1M_UAH)
  },
  [SubscriptionType.HOME_3_MONTHS]: {
    EUR: Number(process.env.PRICE_3M_EUR),
    UAH: Number(process.env.PRICE_3M_UAH)
  },
  [SubscriptionType.HOME_6_MONTHS]: {
    EUR: Number(process.env.PRICE_6M_EUR),
    UAH: Number(process.env.PRICE_6M_UAH)
  }
};
```

**–†–µ—à–µ–Ω–∏–µ –ë (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –ª—É—á—à–µ):**
```prisma
// prisma/schema.prisma
model PricingPlan {
  id       Int    @id @default(autoincrement())
  planType String @unique
  eurPrice Int    // –≤ —Ü–µ–Ω—Ç–∞—Ö
  uahPrice Int    // –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  isActive Boolean @default(true)
}
```

```typescript
// src/storage/pricingStore.ts
export const pricingDb = {
  async getPriceByPlan(plan: SubscriptionType, currency: 'EUR' | 'UAH'): Promise<number> {
    const pricing = await prisma.pricingPlan.findUnique({
      where: { planType: plan, isActive: true }
    });

    if (!pricing) {
      throw new Error(`Pricing not found for plan: ${plan}`);
    }

    return currency === 'EUR' ? pricing.eurPrice : pricing.uahPrice;
  }
};
```

---

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã –ë–î

**–§–∞–π–ª:** `prisma/schema.prisma`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```prisma
model Subscription {
  id         Int      @id @default(autoincrement())
  telegramId Int      // ‚ùå –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞, –∞ –ø–æ–∏—Å–∫ –∏–¥—ë—Ç –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—é
  endDate    DateTime // ‚ùå –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ WHERE
}
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ —Ä–æ—Å—Ç–µ –±–∞–∑—ã –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏
- `getActiveSubscriptions()` –¥–µ–ª–∞–µ—Ç full table scan
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ø—Ä–∏ >10k –ø–æ–¥–ø–∏—Å–æ–∫

**–†–µ—à–µ–Ω–∏–µ:**
```prisma
model Subscription {
  id         Int      @id @default(autoincrement())
  telegramId Int
  username   String
  startDate  DateTime
  endDate    DateTime
  notified   Boolean  @default(false)
  plan       String?
  paymentId  Int?     @unique
  payment    Payment? @relation(fields: [paymentId], references: [id])

  @@index([telegramId])           // –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  @@index([endDate])              // –¥–ª—è scheduler
  @@index([endDate, notified])    // –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –¥–ª—è scheduler
}

model Payment {
  id           Int           @id @default(autoincrement())
  orderId      String        @unique
  userId       String
  provider     String
  amount       Int
  currency     String
  createdAt    DateTime      @default(now())
  subscription Subscription?

  @@index([userId])               // –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  @@index([provider, createdAt])  // –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
}
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
npx prisma migrate dev --name add_indexes
```

---

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ—Å—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–æ–µ–∫—Ç –Ω–µ –∏–º–µ–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ unit/integration —Ç–µ—Å—Ç–∞
- –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å –∫–æ–¥

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–†–µ—à–µ–Ω–∏–µ:**

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
npm install --save-dev jest @types/jest ts-jest
npx ts-jest config:init
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```json
// jest.config.js
export default {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1'
  },
  extensionsToTreatAsEsm: ['.ts'],
  globals: {
    'ts-jest': {
      useESM: true
    }
  }
};
```

**–ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤:**

```typescript
// src/services/payment/__tests__/fondy.service.test.ts
import crypto from 'crypto';
import { createSignature } from '../fondy.service';

describe('Fondy Service', () => {
  describe('createSignature', () => {
    it('should create correct SHA1 signature', () => {
      const data = {
        merchant_id: '123',
        amount: 1200,
        currency: 'EUR'
      };

      const secret = 'test_secret';
      process.env.FONDY_SECRET = secret;

      const signature = createSignature(data);

      // –û–∂–∏–¥–∞–µ–º–∞—è –ø–æ–¥–ø–∏—Å—å
      const expected = crypto
        .createHash('sha1')
        .update(`${secret}|1200|EUR|123`)
        .digest('hex');

      expect(signature).toBe(expected);
    });

    it('should sort keys alphabetically', () => {
      const data = {
        z_field: 'last',
        a_field: 'first',
        m_field: 'middle'
      };

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—è–¥–æ–∫ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      const sig1 = createSignature(data);
      const sig2 = createSignature({ ...data });

      expect(sig1).toBe(sig2);
    });
  });
});
```

```typescript
// src/services/__tests__/subscriptionService.test.ts
import { createSubscription, getPlanDurationMonths } from '../subscriptionService';
import { SubscriptionType } from '../../bot';

describe('Subscription Service', () => {
  describe('getPlanDurationMonths', () => {
    it('should return 1 for 1-month plan', () => {
      expect(getPlanDurationMonths(SubscriptionType.HOME_1_MONTH)).toBe(1);
    });

    it('should return 3 for 3-month plan', () => {
      expect(getPlanDurationMonths(SubscriptionType.HOME_3_MONTHS)).toBe(3);
    });

    it('should return 6 for 6-month plan', () => {
      expect(getPlanDurationMonths(SubscriptionType.HOME_6_MONTHS)).toBe(6);
    });

    it('should return 1 for unknown plan', () => {
      expect(getPlanDurationMonths('UNKNOWN')).toBe(1);
    });
  });
});
```

```typescript
// src/webhooks/__tests__/fondy.webhook.test.ts
import { Request, Response } from 'express';
import { fondyWebhookHandler } from '../fondy.webhook';

describe('Fondy Webhook', () => {
  it('should reject invalid signature', async () => {
    const req = {
      body: {
        order_status: 'approved',
        order_id: 'test_123',
        signature: 'invalid_signature'
      }
    } as Request;

    const res = {
      status: jest.fn().mockReturnThis(),
      send: jest.fn()
    } as unknown as Response;

    await fondyWebhookHandler(req, res);

    expect(res.status).toHaveBeenCalledWith(403);
    expect(res.send).toHaveBeenCalledWith('Invalid signature');
  });
});
```

**package.json:**
```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  }
}
```

---

### 5. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç .gitignore

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å:
- `node_modules/` (—Å–æ—Ç–Ω–∏ –ú–ë)
- `.env` (—Å–µ–∫—Ä–µ—Ç—ã!)
- `dist/` (—Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥)
- `prisma/dev.db` (–ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î)
- –õ–æ–≥–∏, –∫–µ—à–∏ IDE

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø

**–†–µ—à–µ–Ω–∏–µ:**
```gitignore
# .gitignore

# Dependencies
node_modules/
package-lock.json

# Build output
dist/
build/
*.js
*.js.map

# Keep source JS if needed (ESM config files)
!*.config.js

# Environment
.env
.env.local
.env.*.local

# Database
prisma/dev.db
prisma/dev.db-journal
*.db
*.db-journal

# Logs
logs/
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# IDE
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store

# Testing
coverage/
.nyc_output/

# Misc
.cache/
temp/
tmp/
```

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ —É–∂–µ –∑–∞–∫–æ–º–º–∏—Ç–∏–ª–∏ `.env`:
```bash
git rm --cached .env
echo ".env" >> .gitignore
git add .gitignore
git commit -m "Remove .env from tracking"
```

---

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ health check endpoint

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
- Kubernetes/Docker –Ω–µ –º–æ–≥—É—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- –°–ª–æ–∂–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å uptime

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/index.ts

// Health check endpoint
app.get('/health', async (req, res) => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
    await prisma.$queryRaw`SELECT 1`;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω
    const botInfo = await bot.telegram.getMe();

    res.json({
      status: 'ok',
      timestamp: new Date().toISOString(),
      bot: {
        username: botInfo.username,
        id: botInfo.id
      },
      database: 'connected'
    });
  } catch (error) {
    logger.error('Health check failed:', error);
    res.status(503).json({
      status: 'error',
      error: error.message
    });
  }
});

// Readiness probe
app.get('/ready', async (req, res) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –≥–æ—Ç–æ–≤—ã
  const checks = {
    database: false,
    bot: false
  };

  try {
    await prisma.$queryRaw`SELECT 1`;
    checks.database = true;
  } catch {}

  try {
    await bot.telegram.getMe();
    checks.bot = true;
  } catch {}

  const allReady = Object.values(checks).every(v => v);

  res.status(allReady ? 200 : 503).json({
    ready: allReady,
    checks
  });
});
```

---

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ webhooks

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Webhook endpoints –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –≤—Å–µ—Ö
- –í–æ–∑–º–æ–∂–Ω—ã DDoS –∞—Ç–∞–∫–∏
- –ú–æ–∂–Ω–æ —Å–ø–∞–º–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–†–µ—à–µ–Ω–∏–µ:**
```bash
npm install express-rate-limit
```

```typescript
// src/middleware/rateLimiter.ts
import rateLimit from 'express-rate-limit';

export const webhookLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 –º–∏–Ω—É—Ç–∞
  max: 100, // –º–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤
  message: 'Too many requests from this IP',
  standardHeaders: true,
  legacyHeaders: false,
  handler: (req, res) => {
    logger.warn('Rate limit exceeded', {
      ip: req.ip,
      path: req.path
    });
    res.status(429).json({
      error: 'Too many requests'
    });
  }
});

// src/index.ts
import { webhookLimiter } from './middleware/rateLimiter.js';

app.post('/webhook/fondy', webhookLimiter, fondyWebhookHandler);
app.post('/webhook/wayforpay', webhookLimiter, wayForPayWebhookHandler);
```

---

### 8. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ production
- –ù–µ –∑–Ω–∞–µ–º, –∫–æ–≥–¥–∞ –±–æ—Ç –ø–∞–¥–∞–µ—Ç
- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üü° –°–†–ï–î–ù–Ø–Ø

**–†–µ—à–µ–Ω–∏–µ (Sentry –¥–ª—è error tracking):**
```bash
npm install @sentry/node
```

```typescript
// src/utils/sentry.ts
import * as Sentry from '@sentry/node';

export function initSentry() {
  Sentry.init({
    dsn: process.env.SENTRY_DSN,
    environment: process.env.NODE_ENV || 'development',
    tracesSampleRate: 1.0,
    beforeSend(event, hint) {
      // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ dev
      if (process.env.NODE_ENV === 'development') {
        return null;
      }
      return event;
    }
  });
}

// src/index.ts
import { initSentry } from './utils/sentry.js';

initSentry();

// Express middleware
app.use(Sentry.Handlers.requestHandler());
app.use(Sentry.Handlers.tracingHandler());

// ... routes ...

// Error handler (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º)
app.use(Sentry.Handlers.errorHandler());

// Bot error tracking
bot.catch((err, ctx) => {
  Sentry.captureException(err, {
    contexts: {
      telegram: {
        user_id: ctx.from?.id,
        chat_id: ctx.chat?.id,
        update_type: ctx.updateType
      }
    }
  });

  logger.error('Bot error:', err);
  ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ú—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –µ—ë –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º.');
});
```

---

## ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

1. **[–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨] –û—Ç–æ–∑–≤–∞—Ç—å BOT_TOKEN**
   - ‚è± –í—Ä–µ–º—è: 5 –º–∏–Ω—É—Ç
   - üìç –§–∞–π–ª: `.env`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è:
     1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/mybots` –≤ @BotFather
     2. Revoke current token
     3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
     4. –û–±–Ω–æ–≤–∏—Ç—å `.env`
     5. –î–æ–±–∞–≤–∏—Ç—å `.env` –≤ `.gitignore`

2. **[–ë–ê–ì] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏**
   - ‚è± –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç
   - üìç –§–∞–π–ª: `src/services/subscriptionService.ts:10-11`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `getPlanDurationMonths()`
   - üí∞ –í–ª–∏—è–Ω–∏–µ: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–µ–Ω—å–≥–∏!

3. **[–ë–ê–ì] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫**
   - ‚è± –í—Ä–µ–º—è: 20 –º–∏–Ω—É—Ç
   - üìç –§–∞–π–ª: `src/scheduler/notificationScheduler.ts:30`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –î–æ–±–∞–≤–∏—Ç—å `updateSubscriptionNotified()`

4. **[–ë–ê–ì] –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—É–º–º—É –¥–ª—è Fondy**
   - ‚è± –í—Ä–µ–º—è: 5 –º–∏–Ω—É—Ç
   - üìç –§–∞–π–ª: `src/services/payment/fondy.service.ts:30`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: `amount: amount * 100`
   - üí∞ –í–ª–∏—è–Ω–∏–µ: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏!

5. **[–ë–ê–ì] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å grantTelegramAccess**
   - ‚è± –í—Ä–µ–º—è: 1-2 —á–∞—Å–∞
   - üìç –§–∞–π–ª: `src/bot.ts:125`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
   - üí∞ –í–ª–∏—è–Ω–∏–µ: –ö–ª–∏–µ–Ω—Ç—ã –ø–ª–∞—Ç—è—Ç, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø!

---

### üü† –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏)

6. **[–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é env**
   - ‚è± –í—Ä–µ–º—è: 1 —á–∞—Å
   - üìç –§–∞–π–ª: —Å–æ–∑–¥–∞—Ç—å `src/config.ts`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `validateEnv()`

7. **[–ê–†–•–ò–¢–ï–ö–¢–£–†–ê] –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ü–û–°–õ–ï –æ–ø–ª–∞—Ç—ã**
   - ‚è± –í—Ä–µ–º—è: 3-4 —á–∞—Å–∞
   - üìç –§–∞–π–ª—ã: `bot.ts`, `webhooks/*.ts`, `schema.prisma`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è:
     - –î–æ–±–∞–≤–∏—Ç—å `PendingSubscription`
     - –ò–∑–º–µ–Ω–∏—Ç—å flow
     - –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å Payment ‚Üî Subscription

8. **[–ë–ê–ì] –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç WayForPay**
   - ‚è± –í—Ä–µ–º—è: 1-2 —á–∞—Å–∞
   - üìç –§–∞–π–ª: `src/index.ts`
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –°–æ–∑–¥–∞—Ç—å `/pay/wayforpay/:orderId`

9. **[–ö–ê–ß–ï–°–¢–í–û] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**
   - ‚è± –í—Ä–µ–º—è: 2-3 —á–∞—Å–∞
   - üìç –§–∞–π–ª—ã: –≤—Å–µ
   - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è:
     - –ì–ª–æ–±–∞–ª—å–Ω—ã–π error handler
     - Try-catch –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
     - Retry logic

10. **[–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨] –î–æ–±–∞–≤–∏—Ç—å .gitignore** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û
    - ‚è± –í—Ä–µ–º—è: 5 –º–∏–Ω—É—Ç
    - üìç –§–∞–π–ª: `.gitignore`
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –§–∞–π–ª —Å–æ–∑–¥–∞–Ω, dist/ –∏ *.db –¥–æ–±–∞–≤–ª–µ–Ω—ã

11. **[–°–¢–†–£–ö–¢–£–†–ê] –ó–∞–ø–æ–ª–Ω–∏—Ç—å payment.types.ts** üÜï
    - ‚è± –í—Ä–µ–º—è: 20 –º–∏–Ω—É—Ç
    - üìç –§–∞–π–ª: `src/services/payment/payment.types.ts`
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã FondyPaymentRequest, WayForPayPaymentRequest
    - üìñ –°–º. —Ä–∞–∑–¥–µ–ª "–ü—Ä–æ–±–ª–µ–º—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞"

12. **[–°–¢–†–£–ö–¢–£–†–ê] –£–¥–∞–ª–∏—Ç—å testPrisma.ts** üÜï
    - ‚è± –í—Ä–µ–º—è: 2 –º–∏–Ω—É—Ç—ã
    - üìç –§–∞–π–ª: `src/test/testPrisma.ts`
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: `rm -rf src/test/`

---

### üü° –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞)

13. **[–ö–ê–ß–ï–°–¢–í–û] –ó–∞–º–µ–Ω–∏—Ç—å console.log –Ω–∞ logger**
    - ‚è± –í—Ä–µ–º—è: 2 —á–∞—Å–∞
    - üìç –§–∞–π–ª—ã: –≤—Å–µ
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å winston, —Å–æ–∑–¥–∞—Ç—å logger

14. **[–ö–ê–ß–ï–°–¢–í–û] –î–æ–±–∞–≤–∏—Ç—å graceful shutdown**
    - ‚è± –í—Ä–µ–º—è: 1 —á–∞—Å
    - üìç –§–∞–π–ª: `src/index.ts`
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å SIGINT/SIGTERM

15. **[–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨] –ó–∞–º–µ–Ω–∏—Ç—å `any` –Ω–∞ —Ç–∏–ø—ã**
    - ‚è± –í—Ä–µ–º—è: 1 —á–∞—Å
    - üìç –§–∞–π–ª—ã: `payment/*.service.ts`
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (—Å–≤—è–∑–∞–Ω–æ —Å –∑–∞–¥–∞—á–µ–π #11)

16. **[–ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ë–î**
    - ‚è± –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç
    - üìç –§–∞–π–ª: `prisma/schema.prisma`
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: –î–æ–±–∞–≤–∏—Ç—å @@index

17. **[–ö–ê–ß–ï–°–¢–í–û] –í—ã–Ω–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª**
    - ‚è± –í—Ä–µ–º—è: 1 —á–∞—Å
    - üìç –§–∞–π–ª: —Å–æ–∑–¥–∞—Ç—å `src/messages/ru.ts`

18. **[–ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê] –î–æ–±–∞–≤–∏—Ç—å health checks**
    - ‚è± –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç
    - üìç –§–∞–π–ª: `src/index.ts`
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: `/health` –∏ `/ready` endpoints

---

### üü¢ –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (nice to have)

19. **[–ö–ê–ß–ï–°–¢–í–û] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã**
    - ‚è± –í—Ä–µ–º—è: 5-10 —á–∞—Å–æ–≤
    - ‚úÖ –î–µ–π—Å—Ç–≤–∏—è: Jest + unit/integration —Ç–µ—Å—Ç—ã

20. **[–ö–ê–ß–ï–°–¢–í–û] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞**
    - ‚è± –í—Ä–µ–º—è: 2 —á–∞—Å–∞
    - üìç –§–∞–π–ª: `src/bot.ts:74-111`

21. **[–ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Sentry)**
    - ‚è± –í—Ä–µ–º—è: 1 —á–∞—Å

22. **[–ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê] Rate limiting –Ω–∞ webhooks**
    - ‚è± –í—Ä–µ–º—è: 30 –º–∏–Ω—É—Ç

23. **[–ì–ò–ë–ö–û–°–¢–¨] –í—ã–Ω–µ—Å—Ç–∏ —Ü–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥/–ë–î**
    - ‚è± –í—Ä–µ–º—è: 2 —á–∞—Å–∞

24. **[–ö–ê–ß–ï–°–¢–í–û] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–µ**
    - ‚è± –í—Ä–µ–º—è: 1 —á–∞—Å

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. TypeScript Strict Mode

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```json
{
  "compilerOptions": {
    "strict": false
  }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "alwaysStrict": true
  }
}
```

**–ü–æ–ª—å–∑–∞:**
- –ú–µ–Ω—å—à–µ runtime –æ—à–∏–±–æ–∫
- –õ—É—á—à–µ autocomplete
- –ö–æ–¥ —Å–∞–º–æ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

---

### 2. ESLint + Prettier

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
npm install --save-dev eslint prettier @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-config-prettier
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```json
// .eslintrc.json
{
  "parser": "@typescript-eslint/parser",
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "prettier"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "no-console": ["warn", { "allow": ["warn", "error"] }]
  }
}
```

```json
// .prettierrc
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2
}
```

---

### 3. Environment-specific configs

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
.env.development
.env.staging
.env.production
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
npm install dotenv-cli

# package.json
{
  "scripts": {
    "dev": "dotenv -e .env.development tsx src/index.ts",
    "start:staging": "dotenv -e .env.staging node dist/index.js",
    "start:production": "dotenv -e .env.production node dist/index.js"
  }
}
```

---

### 4. Docker

**Dockerfile:**
```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

**docker-compose.yml:**
```yaml
version: '3.8'

services:
  bot:
    build: .
    env_file: .env.production
    ports:
      - "3000:3000"
    volumes:
      - ./prisma:/app/prisma
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

---

### 5. CI/CD (GitHub Actions)

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

---

### 6. Database Migration –Ω–∞ PostgreSQL

**–î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PostgreSQL –≤–º–µ—Å—Ç–æ SQLite:**

```prisma
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

**.env.production:**
```
DATABASE_URL="postgresql://user:password@localhost:5432/telegram_bot?schema=public"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ—É—á—à–µ –¥–ª—è concurrent requests
- –ë–æ–ª—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π (full-text search, JSON queries)
- –õ—É—á—à–µ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

### 7. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

**Prometheus + Grafana:**
```bash
npm install prom-client
```

```typescript
// src/utils/metrics.ts
import promClient from 'prom-client';

const register = new promClient.Registry();

export const metrics = {
  subscriptionsCreated: new promClient.Counter({
    name: 'subscriptions_created_total',
    help: 'Total subscriptions created',
    labelNames: ['plan']
  }),

  paymentsProcessed: new promClient.Counter({
    name: 'payments_processed_total',
    help: 'Total payments processed',
    labelNames: ['provider', 'currency']
  }),

  paymentAmount: new promClient.Histogram({
    name: 'payment_amount',
    help: 'Payment amounts',
    labelNames: ['currency']
  })
};

Object.values(metrics).forEach(metric => register.registerMetric(metric));

// src/index.ts
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});
```

---

### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

**–î–ª—è webhook endpoints:**
```typescript
// src/index.ts

/**
 * @api {post} /webhook/fondy Fondy Payment Callback
 * @apiName FondyWebhook
 * @apiGroup Webhooks
 *
 * @apiParam {String} order_id Order ID
 * @apiParam {String} order_status Payment status (approved/declined)
 * @apiParam {Number} amount Payment amount in cents
 * @apiParam {String} currency Currency code (EUR)
 * @apiParam {String} signature SHA1 signature
 */
app.post('/webhook/fondy', fondyWebhookHandler);
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–ï–ö–¢–ê

### –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –û—Ü–µ–Ω–∫–∞ |
|---------|----------|--------|
| Test Coverage | 0% | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è |
| Type Safety | 60% | üü° –°—Ä–µ–¥–Ω—è—è |
| Error Handling | 10% | üî¥ –ü–ª–æ—Ö–∞—è |
| Security | 40% | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è |
| Documentation | 20% | üî¥ –ü–ª–æ—Ö–∞—è |
| Code Duplication | –í—ã—Å–æ–∫–∞—è | üü° –°—Ä–µ–¥–Ω—è—è |

---

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** üî¥ –í—ã—Å–æ–∫–∏–π

**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:** ~15-20 —á–∞—Å–æ–≤

**–†–∞–∑–±–∏–≤–∫–∞:**
- üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏: 5 –ø—Ä–æ–±–ª–µ–º (~6 —á–∞—Å–æ–≤)
- üî¥ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 4 –ø—Ä–æ–±–ª–µ–º—ã (~3 —á–∞—Å–∞)
- üü† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 4 –ø—Ä–æ–±–ª–µ–º—ã (~10 —á–∞—Å–æ–≤)
- üü° –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: 10+ –ø—Ä–æ–±–ª–µ–º (~15 —á–∞—Å–æ–≤)

---

## ‚ú® –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç **—Ö–æ—Ä–æ—à—É—é –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É** –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (TypeScript, Prisma, Telegraf). –û–¥–Ω–∞–∫–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥**, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ production.

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ TypeScript –¥–ª—è type-safety
- ‚úÖ Prisma ORM
- ‚úÖ –î–≤–æ–π–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
- ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏)
- ‚ùå –£—Ç–µ—á–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- ‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–æ –æ–ø–ª–∞—Ç—ã
- ‚ùå –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
**–ù–ï –ó–ê–ü–£–°–ö–ê–¢–¨ –í PRODUCTION** –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º (–ø—É–Ω–∫—Ç—ã 1-10 –∏–∑ –ø–ª–∞–Ω–∞).

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–∞–≥–æ–≤ –ø—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ **beta-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**. –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ production-–∑–∞–ø—É—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—É–Ω–∫—Ç—ã 11-16.

---

**–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π ‚Äî –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å!**
